name: Publish Extension

on:
  push:
    tags:
      - 'v*' # 只有当你推送以 'v' 开头的标签时触发（如 v0.1.3）

permissions:
  contents: read

jobs:
  build_and_publish:
    name: Build and Publish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        # 使用 npm ci 进行更干净、确定的依赖安装，适合 CI 环境
        run: npm ci

      - name: Run Compile
        # 显式运行编译，确保 TypeScript 代码没有错误
        run: npm run compile

      - name: Publish to Marketplaces
        # 使用这个成熟的 Action 可以同时处理打包和发布
        uses: HaaLeo/publish-vscode-extension@v1
        with:
          # 对应的 Secret 名字要和你在 Settings 里设置的一样
          pat: ${{ secrets.VSCE_PAT }}       # 微软市场 Token
          ovsxToken: ${{ secrets.OVSX_PAT }} # Open VSX Token
          
          # 如果你只想发布到 Open VSX，不想发到微软市场，
          # 可以把 pat 那一行删掉，Action 会自动跳过微软市场。
